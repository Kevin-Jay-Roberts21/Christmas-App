{% extends "base.html" %}
{% block content %}
{% set mem_map = mem_map|default({}) %}
{% set list_for_group = list_for_group|default({}) %}
{% set gifts_by_person = gifts_by_person|default({}) %}
{% set giftee_map = giftee_map|default({}) %}

<h2>Account</h2>

<section class="card">
  <div class="card-header">
    <h3>Your Lists</h3>
    <a class="btn" href="/lists/new">Create List</a>
  </div>

  {% if lists|length == 0 %}
    <p>You don’t have any lists yet. Click “Create List” to get started.</p>
  {% else %}
    <ul>
      {% for lst in lists %}
        <li>
          <strong>{{ lst.name }}</strong>
          <a class="btn btn-small" href="/lists/{{ lst.id }}">View</a>
          <a class="btn btn-small" href="/lists/{{ lst.id }}/edit">Edit</a>
        </li>
      {% endfor %}
    </ul>
  {% endif %}
</section>

<section class="card">
  <div class="card-header">
    <h3>Your Groups</h3>
  </div>

  {% if groups|length == 0 %}
    <p>You’re not in any groups yet.</p>
  {% else %}
    <ul>
      {% for g in groups %}
        {% set mem = mem_map.get(g.id) %}
        <li>
          <strong>{{ g.name }}</strong>
          {% if mem and not mem.is_approved and not mem.is_denied and not mem.is_invite %}
            <span class="tag">Pending</span>
          {% elif mem and mem.is_denied %}
            <span class="tag" style="background:#fee2e2;color:#991b1b;">Denied</span>
          {% else %}
            <a href="/groups/{{ g.id }}" class="btn">View Group</a>
          {% endif %}

          {% if mem and mem.selected_list_id %}
            <small> Your applied list:
              <a href="/lists/{{ mem.selected_list_id }}">View List</a>
            </small>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% endif %}
</section>

<section class="card">
  <div class="card-header">
    <h3>The Gifts You're Giving</h3>
  </div>

  {% if gifts_by_person and gifts_by_person|length > 0 %}
    {% for giftee_id, items in gifts_by_person.items() %}
      {% set person = giftee_map.get(giftee_id) %}
      <div style="margin-top: 1rem;">
        <strong>{{ person.username if person else "Unknown person" }}</strong>
        <ul style="margin: .25rem 0 0 1rem;">
          {% for it in items %}
            <li>
              {{ it.name }}
              {% if it.url %}
                – <a href="{{ it.url }}" target="_blank" rel="noopener">link</a>
              {% endif %}
            </li>
          {% endfor %}
        </ul>
      </div>
    {% endfor %}
  {% else %}
    <p>You haven’t committed to any gifts yet. Once you check something in a group, they’ll show up here.</p>
  {% endif %}
</section>


<hr style="margin:2rem 0;">

<h3>Danger zone</h3>
<p class="muted">
  Deleting your account will remove all of your groups, lists, items, and group memberships.
  This cannot be undone.
</p>

<form method="post"
      action="/account/delete"
      onsubmit="return confirm('Are you sure you want to permanently delete your account and all your data?');">
  <button class="btn btn-outline" type="submit">
    Delete my account
  </button>
</form>

{% endblock %}
