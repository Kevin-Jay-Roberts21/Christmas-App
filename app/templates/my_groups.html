{% extends "base.html" %}
{% block content %}
<h2>My Groups</h2>


<section class="card">
  <div class="card-header">
    <h3>Invitations for you</h3>
  </div>
  {# Build invites list: pending + not denied + came from leader #}
  {% set invites = [] %}
  {% for g in groups %}
  {% set mem = mem_map.get(g.id) %}
  {% if not (mem and mem.is_invite and not mem.is_approved and not mem.is_denied) %}
    {% set mem = mem_map.get(g.id) %}
    {% if mem and (not mem.is_approved) and (not mem.is_denied) and mem.is_invite %}
      {% set _ = invites.append((g, mem)) %}
    {% endif %}
    {% endif %}
{% endfor %}

  {% if invites|length == 0 %}
    <p>No invitations right now.</p>
  {% else %}
    <ul>
      {% for g, mem in invites %}
        <li>
          <strong>{{ g.name }}</strong>
          <form method="post" action="/groups/{{ g.id }}/accept_invite" style="display:inline-block; margin-left:8px;">
            <label style="margin-right:8px;">Select your list
              <select name="selected_list_id" required>
                {% for gl in me.lists %}
                  <option value="{{ gl.id }}">{{ gl.name }}</option>
                {% endfor %}
              </select>
            </label>
            <button class="btn" type="submit">Accept</button>
          </form>
          <form method="post" action="/groups/{{ g.id }}/decline_invite" style="display:inline-block; margin-left:6px;">
            <button class="btn" type="submit">Decline</button>
          </form>
        </li>
      {% endfor %}
    </ul>
  {% endif %}
</section>


<section class="card">
  <div class="card-header">
    <h3>Groups you’re in</h3>
    <div>
      <a class="btn" href="/groups/new">Create Group</a>
      <a class="btn" href="/groups/join" style="margin-left:8px;">Join Group</a>
    </div>
  </div>

  {% if groups|length == 0 %}
    <p>You’re not in any groups yet. Create a new one or join an existing group.</p>
  {% else %}
    <ul>
      {% for g in groups %}
        {% set mem = mem_map.get(g.id) %}
        <li>
          {% set mem = mem_map.get(g.id) %}
          {% if mem and not mem.is_approved and not mem.is_denied %}
            <span>{{ g.name }}</span> <span class="tag">Pending</span>
          {% elif mem and mem.is_denied %}
            <span>{{ g.name }}</span> <span class="tag" style="background:#fee2e2;color:#991b1b;">Denied</span>
            <form method="post" action="/groups/{{ g.id }}/remove_denied" style="display:inline;margin-left:6px;">
              <button class="btn" title="Remove">✕</button>
            </form>
          {% else %}
            <a href="/groups/{{ g.id }}">{{ g.name }}</a>
            {% if g.leader_id == me.id %}<span class="tag">Leader</span>{% endif %}
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% endif %}
</section>
{% endblock %}
